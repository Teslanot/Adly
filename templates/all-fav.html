{% extends 'base.html' %}
{% block title %} Избранное {% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 to-white pb-10">
  <!-- Навигация -->
  <nav class="sticky top-0 z-50 backdrop-blur-xl bg-white/95 border-b border-white/20 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-center overflow-x-auto">
        <div class="flex space-x-1 p-2 flex-nowrap scrollbar-hide">
          <a href="{% url 'home' %}" class="flex-shrink-0 nav-link active px-6 py-3 text-sm font-medium text-white bg-gradient-to-r from-blue-600 to-blue-500 rounded-lg shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-300">Главная</a>
          <a href="{% url 'top_sellers' %}" class="flex-shrink-0 px-6 py-3 text-sm font-medium text-gray-700 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition">Топ продавцов</a>
          {% if user.is_authenticated %}
          <a href="{% url 'post_adv' %}" class="flex-shrink-0 px-6 py-3 text-sm font-medium text-gray-700 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition">Разместить объявление</a>
          <a href="{% url 'profile' %}" class="flex-shrink-0 px-6 py-3 text-sm font-medium text-gray-700 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition">Профиль</a>
          <a href="{% url 'logout' %}" class="flex-shrink-0 px-6 py-3 text-sm font-medium text-gray-700 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition">Выйти</a>
          {% else %}
          <a href="{% url 'sign_in' %}" class="flex-shrink-0 px-6 py-3 text-sm font-medium text-gray-700 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition">Регистрация</a>
          <a href="{% url 'login' %}" class="flex-shrink-0 px-6 py-3 text-sm font-medium text-gray-700 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition">Войти</a>
          {% endif %}
        </div>
      </div>
    </div>
  </nav>

  <!-- Заголовок -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-10">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Мои избранные объявления</h1>

    <div class="nav-tabs mb-8">
      <div class="flex space-x-2 p-2 overflow-x-auto flex-nowrap scrollbar-hide">
        <a href=".." class="flex-shrink-0 px-6 py-3 text-sm font-medium text-gray-700 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all duration-300">
          Проверенные продавцы
        </a>
        {% if user.is_authenticated %}
        <a href="#" class="nav-link active flex-shrink-0 px-6 py-3 text-sm font-medium text-white bg-blue-600 rounded-lg shadow-sm">
          Избранное
        </a>
        {% endif %}
      </div>
    </div>

    {% if favorite_list %}
      <div class="grid gap-6 md:grid-cols-2">
        {% for adv in favorite_list %}
          <div class="bg-white border border-gray-200 rounded-lg shadow hover:shadow-md transition overflow-hidden">
            {% if adv.image %}
              <a href="{{ adv.get_absolute_url }}">
                <img src="{{ adv.image.url }}" alt="{{ adv.title }}" class="w-full h-48 object-cover">
              </a>
            {% endif %}
            <div class="p-6">
              <h2 class="text-xl font-semibold mb-2">
                <a href="{{ adv.get_absolute_url }}" class="hover:text-blue-600 transition">{{ adv.title }}</a>
              </h2>
              <p class="text-gray-600 mb-2">{{ adv.descriptions|truncatewords:20 }}</p>
              <p class="text-sm text-gray-400 mb-2">Автор: {{ adv.user }}</p>
              <p class="text-gray-700 font-semibold mb-4">Цена: {{ adv.prices }}</p>
              <div class="flex gap-2">
                {% if user in adv.favorites.all %}
                  <button type="submit" class="fav_toggle bg-gradient-to-r from-red-500 to-red-600 text-white px-4 py-2 rounded-lg font-medium hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-300"
                    data-adv-id="{{ adv.id }}"
                    data-action="removed"
                  >
                    Удалить из избранного
                  </button>
                {% else %}
                  <button type="submit" class="fav_toggle bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-300"
                    data-adv-id="{{ adv.id }}"
                    data-action="added"
                  >
                    Добавить в избранное
                  </button>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-gray-600 italic">У вас пока нет избранных объявлений.</p>
    {% endif %}
  </div>
</div>
<script>
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('fav_toggle')) {
    const button = e.target;
    const advId = button.dataset.advId;
    const action = button.dataset.action;
    const url = action === 'add'
      ? `/add_to_favorites/${advId}/`
      : `/remove_from_favorite/${advId}/`;

    fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Accept': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        if (action === 'add') {
          button.textContent = 'Удалить из избранного';
          button.dataset.action = 'remove';
          button.classList.remove('from-blue-500', 'to-blue-600');
          button.classList.add('from-red-500', 'to-red-600');
        } else {
          button.textContent = 'Добавить в избранное';
          button.dataset.action = 'add';
          button.classList.remove('from-red-500', 'to-red-600');
          button.classList.add('from-blue-500', 'to-blue-600');
        }
      }
    })
    .catch(error => console.error(error));
  }
});
</script>
{% endblock %}